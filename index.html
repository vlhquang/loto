<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loto Master Pro - Hệ Thống Gọi Số Chuyên Nghiệp</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Digital-7';
            src: url('https://fonts.cdnfonts.com/s/14101/digital-7.mono.woff') format('woff');
        }
        .digital-font { font-family: 'Digital-7', monospace; }
        body {
            font-family: 'Montserrat', sans-serif;
            background: radial-gradient(circle, #0f172a 0%, #020617 100%);
            min-height: 100vh;
            color: white;
            overflow: hidden;
        }
        .loto-ball-active {
            box-shadow: 0 0 20px #facc15;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 10px #facc15; }
            50% { transform: scale(1.1); box-shadow: 0 0 30px #facc15; }
            100% { transform: scale(1); box-shadow: 0 0 10px #facc15; }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #facc1533; border-radius: 10px; }
        .animate-spin-slow { animation: spin 4s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .modal-overlay { 
            display: none; 
            backdrop-filter: blur(12px); 
            background-color: rgba(0, 0, 0, 0.85);
        }
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes scaleIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .menu-item-label {
            white-space: nowrap;
            pointer-events: none;
        }
        .hidden { display: none !important; }

        .delay-ctrl-btn {
            @apply flex items-center justify-center text-slate-500 hover:text-yellow-400 transition-all duration-200 cursor-pointer active:scale-75 p-3;
        }
    </style>
</head>
<body class="select-none">

    <div class="max-w-7xl mx-auto px-4 py-4 md:py-6 h-screen flex flex-col overflow-hidden">
        
        <div class="flex-1 flex flex-col md:flex-row gap-4 min-h-0">
            
            <!-- Khu vực gọi số chính -->
            <div id="callingPanel" class="flex flex-col items-center justify-center p-4 bg-slate-900/40 border border-slate-800/60 rounded-[2.5rem] md:w-1/3 xl:w-1/4 flex-shrink-0 relative overflow-hidden shadow-2xl backdrop-blur-xl">
                
                <!-- Speed Info Control -->
                <div class="absolute top-10 left-8 flex flex-col items-center z-50">
                    <button id="btnIncreaseDelay" class="delay-ctrl-btn" title="Chậm lại (+0.1s)">
                        <i class="fas fa-chevron-up text-xs"></i>
                    </button>
                    
                    <div class="text-center py-1 select-none pointer-events-none">
                        <div class="text-[7px] font-black uppercase tracking-[0.3em] text-slate-500 leading-none mb-1">Delay</div>
                        <div id="delayDisplay" class="text-base font-black text-yellow-400 leading-none digital-font min-w-[45px]">3.0s</div>
                    </div>
                    
                    <button id="btnDecreaseDelay" class="delay-ctrl-btn" title="Nhanh hơn (-0.1s)">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                </div>

                <div class="flex flex-row items-center justify-center w-full h-full relative px-6">
                    <!-- Main Rolling Circle -->
                    <div id="mainButton" class="relative group cursor-pointer transition-transform active:scale-95">
                        <div class="absolute inset-0 bg-yellow-400/5 blur-[50px] rounded-full opacity-30"></div>
                        <div id="ballRing" class="relative w-44 h-44 md:w-48 md:h-48 lg:w-56 lg:h-56 bg-black/60 rounded-full border-[8px] border-slate-800 flex items-center justify-center shadow-[inset_0_0_60px_rgba(0,0,0,0.9)] transition-all duration-500">
                            <div id="mainNumber" class="digital-font text-[7rem] md:text-[8rem] lg:text-[10.5rem] leading-none text-yellow-400">--</div>
                            
                            <div id="autoBadge" class="hidden absolute bottom-4 flex flex-col items-center">
                                <div class="flex items-center gap-1.5 px-3 py-1 rounded-full bg-black/70 border border-green-500/30 text-[8px] font-black uppercase tracking-[0.15em] text-green-400 backdrop-blur-md">
                                    <i class="fas fa-play animate-pulse"></i> <span id="autoStatusText">Auto</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- History Slots Pinned -->
                    <div class="absolute right-1 md:right-2 top-1/2 -translate-y-1/2 flex flex-col gap-4">
                        <div data-slot="0" class="recent-slot w-10 h-10 md:w-12 md:h-12 rounded-xl flex items-center justify-center text-sm font-black border border-slate-800/30 border-dashed bg-black/20 text-slate-800 opacity-40 transition-all duration-300">--</div>
                        <div data-slot="1" class="recent-slot w-10 h-10 md:w-12 md:h-12 rounded-xl flex items-center justify-center text-sm font-black border border-slate-800/30 border-dashed bg-black/20 text-slate-800 opacity-40 transition-all duration-300">--</div>
                        <div data-slot="2" class="recent-slot w-10 h-10 md:w-12 md:h-12 rounded-xl flex items-center justify-center text-sm font-black border border-slate-800/30 border-dashed bg-black/20 text-slate-800 opacity-40 transition-all duration-300">--</div>
                    </div>
                </div>
            </div>

            <!-- Bảng lịch sử các số -->
            <div id="historyGrid" class="flex-1 bg-slate-900/50 border border-slate-800/60 p-5 md:p-8 rounded-[2.5rem] shadow-2xl backdrop-blur-md overflow-y-auto custom-scrollbar relative">
                <div id="gridContainer" class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-9 lg:grid-cols-10 xl:grid-cols-12 gap-3 justify-items-center pb-10">
                    <!-- Balls injected by JS -->
                </div>
            </div>
        </div>

        <!-- Footer Info -->
        <footer class="py-2.5 text-center opacity-10 text-[7px] font-black uppercase tracking-[0.6em]">
            Loto Master Elite Engine • Professional Raffle v3.8
        </footer>
    </div>

    <!-- Floating Menu -->
    <div class="fixed bottom-6 right-6 z-[100] flex flex-col items-end gap-5">
        <!-- menuOptions container: Dùng gap-5 để giãn cách đều các nút chức năng -->
        <div id="menuOptions" class="hidden flex flex-col gap-5 items-end">
            <div class="flex items-center justify-end gap-3 group">
                <span id="autoLabel" class="menu-item-label text-[9px] font-black uppercase text-slate-100 bg-black/80 px-2 py-1.5 rounded-lg border border-white/10 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity">Tự động: Tắt</span>
                <button id="autoToggleBtn" class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center shadow-xl border border-white/5 active:scale-90 transition-all hover:bg-slate-600">
                    <i class="fas fa-hand-pointer text-white text-lg"></i>
                </button>
            </div>
            <div class="flex items-center justify-end gap-3 group">
                <span id="soundLabel" class="menu-item-label text-[9px] font-black uppercase text-slate-100 bg-black/80 px-2 py-1.5 rounded-lg border border-white/10 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity">Loa: Bật</span>
                <button id="soundToggleBtn" class="w-12 h-12 rounded-full bg-indigo-600 flex items-center justify-center shadow-xl border border-white/5 active:scale-90 transition-all hover:bg-indigo-500">
                    <i class="fas fa-volume-up text-white text-lg"></i>
                </button>
            </div>
            <div class="flex items-center justify-end gap-3 group">
                <span class="menu-item-label text-[9px] font-black uppercase text-slate-100 bg-black/80 px-2 py-1.5 rounded-lg border border-white/10 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity">Cài đặt</span>
                <button onclick="toggleModal('#settingsModal')" class="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center shadow-xl border border-white/5 active:scale-90 transition-all hover:bg-slate-700">
                    <i class="fas fa-cog text-white text-lg"></i>
                </button>
            </div>
            <div class="flex items-center justify-end gap-3 group">
                <span class="menu-item-label text-[9px] font-black uppercase text-slate-100 bg-black/80 px-2 py-1.5 rounded-lg border border-white/10 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity">Chơi lại</span>
                <button onclick="resetGame()" class="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center shadow-xl border border-white/5 active:scale-90 transition-all hover:bg-red-500">
                    <i class="fas fa-sync-alt text-white text-lg"></i>
                </button>
            </div>
        </div>
        <!-- Menu chính: Sử dụng gap-5 từ parent div để giữ khoảng cách đều -->
        <button id="menuMainBtn" class="w-14 h-14 rounded-full bg-yellow-400 flex items-center justify-center shadow-2xl border-2 border-yellow-300 transition-all duration-300 shadow-yellow-400/30 active:scale-90">
            <i class="fas fa-bars text-slate-900 text-xl"></i>
        </button>
    </div>

    <!-- Modals -->
    <div id="settingsModal" class="modal-overlay hidden fixed inset-0 z-[150] flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-800 rounded-[2.5rem] w-full max-md shadow-2xl overflow-hidden scale-in">
            <div class="p-7 flex justify-between items-center border-b border-slate-800 bg-slate-800/20">
                <h2 class="text-xl font-black text-yellow-400 uppercase italic tracking-wider">Cấu Hình</h2>
                <button onclick="toggleModal('#settingsModal')" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white transition-all"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-7 space-y-7">
                <div class="space-y-2.5">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest block">Số tối đa (N)</label>
                    <input id="maxNumInput" type="number" min="1" max="999" class="w-full bg-slate-950 border border-slate-800 rounded-2xl px-5 py-4 focus:border-yellow-400 outline-none text-yellow-400 font-black text-2xl shadow-inner">
                </div>
                <div class="space-y-2.5">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest block">API Webhook</label>
                    <input id="apiInput" type="url" placeholder="https://..." class="w-full bg-slate-950 border border-slate-800 rounded-2xl px-5 py-4 focus:border-yellow-400 outline-none text-indigo-400 text-xs shadow-inner">
                </div>
            </div>
            <div class="p-7 pt-0">
                <button onclick="saveConfig()" class="w-full py-5 bg-gradient-to-r from-yellow-400 to-orange-500 text-slate-900 font-black text-sm rounded-2xl uppercase tracking-[0.2em] shadow-xl hover:shadow-yellow-500/20 active:translate-y-1 transition-all">Lưu cài đặt</button>
            </div>
        </div>
    </div>

    <script>
        // --- Globals ---
        let config = {
            maxNumber: 90,
            apiEndpoint: '',
            isSoundEnabled: true,
            autoSpeed: 3000
        };

        let state = {
            calledNumbers: [],
            currentNumber: null,
            isRolling: false,
            isAutoPlaying: false,
            isAutoModeEnabled: false
        };

        let autoTimeout = null;
        const AUDIO_BASE_URL = "https://raw.githubusercontent.com/vlhquang/loto/main/audio/";

        // --- Core Functions ---
        function adjustSpeed(delta) {
            config.autoSpeed = Math.max(500, Math.min(10000, config.autoSpeed + delta));
            updateDelayDisplay();
            localStorage.setItem('loto_config_final', JSON.stringify(config));
        }

        function updateDelayDisplay() {
            $('#delayDisplay').text((config.autoSpeed / 1000).toFixed(1) + 's');
        }

        function init() {
            const savedConfig = localStorage.getItem('loto_config_final');
            if (savedConfig) config = JSON.parse(savedConfig);

            const savedState = localStorage.getItem('loto_state_final');
            if (savedState) {
                state = JSON.parse(savedState);
                state.isRolling = false;
                state.isAutoPlaying = false;
            }

            $('#maxNumInput').val(config.maxNumber);
            $('#apiInput').val(config.apiEndpoint);
            
            updateDelayDisplay();
            updateSoundUI();
            renderGrid();
            renderRecentSlots();
            
            if (state.currentNumber) {
                $('#mainNumber').text(state.currentNumber.toString().padStart(2, '0'));
            }
        }

        function saveConfig() {
            const newMax = parseInt($('#maxNumInput').val()) || 90;
            config.maxNumber = newMax;
            config.apiEndpoint = $('#apiInput').val();
            localStorage.setItem('loto_config_final', JSON.stringify(config));
            toggleModal('#settingsModal');
            renderGrid();
        }

        function persistState() {
            localStorage.setItem('loto_state_final', JSON.stringify(state));
        }

        function renderGrid() {
            const $container = $('#gridContainer').empty();
            for (let i = 1; i <= config.maxNumber; i++) {
                const isCalled = state.calledNumbers.includes(i);
                const isLatest = state.currentNumber === i;
                const ball = $(`
                    <div data-num="${i}" class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center text-[10px] md:text-xs font-bold transition-all duration-500
                        ${isCalled ? (isLatest ? 'bg-yellow-400 text-slate-900 loto-ball-active z-10 scale-110 border-2 border-yellow-200' : 'bg-blue-600 text-white shadow-lg shadow-blue-900/40') : 'bg-slate-800 text-slate-600 border border-slate-700 opacity-40'}">
                        ${i.toString().padStart(2, '0')}
                    </div>
                `);
                $container.append(ball);
            }
        }

        function renderRecentSlots() {
            const history = [...state.calledNumbers].reverse();
            $('.recent-slot').each(function(i) {
                const num = history[i];
                const $slot = $(this);
                if (num !== undefined && num !== null) {
                    $slot.text(num.toString().padStart(2, '0'))
                         .removeClass('bg-black/20 text-slate-800 border-dashed opacity-40')
                         .addClass('bg-slate-800/60 text-slate-300 border-solid opacity-80');
                    if (i === 0) {
                        $slot.addClass('bg-yellow-400 text-slate-900 border-yellow-400 shadow-lg shadow-yellow-400/20 scale-105 z-10').removeClass('bg-slate-800/60 text-slate-300');
                    } else {
                        $slot.removeClass('bg-yellow-400 text-slate-900 border-yellow-400 shadow-lg shadow-yellow-400/20 scale-105 z-10');
                    }
                } else {
                    $slot.text('--').addClass('bg-black/20 text-slate-800 border-dashed opacity-40').removeClass('bg-yellow-400 bg-slate-800/60 text-slate-900 text-slate-300 border-solid scale-105 z-10 shadow-lg shadow-yellow-400/20');
                }
            });
        }

        function callNumber() {
            if (state.isRolling) return;
            
            const available = [];
            for (let i = 1; i <= config.maxNumber; i++) {
                if (!state.calledNumbers.includes(i)) available.push(i);
            }

            if (available.length === 0) {
                alert("Đã gọi hết tất cả các số!");
                state.isAutoPlaying = false;
                updateAutoBadge();
                return;
            }

            state.isRolling = true;
            $('#ballRing').addClass('border-yellow-400 shadow-[0_0_30px_rgba(250,204,21,0.2)]');
            $('#mainNumber').addClass('animate-pulse');

            let cycles = 0;
            let currentDelay = 40;
            const maxCycles = 25;

            const roll = () => {
                cycles++;
                const randomDisplay = Math.floor(Math.random() * config.maxNumber) + 1;
                $('#mainNumber').text(randomDisplay.toString().padStart(2, '0'));

                if (cycles < maxCycles) {
                    if (cycles > maxCycles * 0.6) currentDelay *= 1.25;
                    setTimeout(roll, currentDelay);
                } else {
                    const finalNum = available[Math.floor(Math.random() * available.length)];
                    finalizeNumber(finalNum);
                }
            };
            roll();
        }

        function finalizeNumber(num) {
            state.isRolling = false;
            state.currentNumber = num;
            state.calledNumbers.push(num);
            
            $('#mainNumber').text(num.toString().padStart(2, '0')).removeClass('animate-pulse');
            $('#ballRing').removeClass('border-yellow-400 shadow-[0_0_30px_rgba(250,204,21,0.2)]');
            
            renderGrid();
            renderRecentSlots();
            playAudio(num);
            sendWebhook(num);
            persistState();

            if (state.isAutoModeEnabled && state.isAutoPlaying) {
                autoTimeout = setTimeout(callNumber, config.autoSpeed);
            }
        }

        function sendWebhook(num) {
            if (!config.apiEndpoint) return;
            const payload = {
                number: num,
                calledAt: Date.now(),
                history: state.calledNumbers
            };
            fetch(config.apiEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(err => console.warn('API Error:', err));
        }

        function playAudio(num) {
            if (!config.isSoundEnabled) return;
            const audioUrl = `${AUDIO_BASE_URL}number_${num}.mp3`;
            const audio = new Audio(audioUrl);
            audio.play().catch(e => {
                console.warn(`Không thể phát âm thanh: ${audioUrl}`);
            });
        }

        function toggleAutoMode() {
            state.isAutoModeEnabled = !state.isAutoModeEnabled;
            state.isAutoPlaying = false;
            clearTimeout(autoTimeout);
            
            if (state.isAutoModeEnabled) {
                $('#autoToggleBtn').removeClass('bg-slate-700').addClass('bg-yellow-400').find('i').removeClass('fa-hand-pointer').addClass('fa-sync animate-spin-slow text-slate-900');
                $('#autoLabel').text('Tự động: Bật');
                $('#autoBadge').removeClass('hidden');
                updateAutoBadge();
            } else {
                $('#autoToggleBtn').addClass('bg-slate-700').removeClass('bg-yellow-400').find('i').addClass('fa-hand-pointer').removeClass('fa-sync animate-spin-slow text-slate-900');
                $('#autoLabel').text('Tự động: Tắt');
                $('#autoBadge').addClass('hidden');
            }
        }

        function startStopAuto() {
            if (!state.isAutoModeEnabled) return;
            state.isAutoPlaying = !state.isAutoPlaying;
            updateAutoBadge();
            
            if (state.isAutoPlaying) {
                callNumber();
            } else {
                clearTimeout(autoTimeout);
            }
        }

        function updateAutoBadge() {
            const $span = $('#autoStatusText');
            const $icon = $('#autoBadge i');
            if (state.isAutoPlaying) {
                $span.text('Running');
                $icon.removeClass('fa-pause text-red-400').addClass('fa-play text-green-400');
            } else {
                $span.text('Paused');
                $icon.removeClass('fa-play text-green-400').addClass('fa-pause text-red-400');
            }
        }

        function toggleSound() {
            config.isSoundEnabled = !config.isSoundEnabled;
            updateSoundUI();
            localStorage.setItem('loto_config_final', JSON.stringify(config));
        }

        function updateSoundUI() {
            if (config.isSoundEnabled) {
                $('#soundToggleBtn').addClass('bg-indigo-600').removeClass('bg-slate-700').find('i').removeClass('fa-volume-mute').addClass('fa-volume-up');
                $('#soundLabel').text('Loa: Bật');
            } else {
                $('#soundToggleBtn').removeClass('bg-indigo-600').addClass('bg-slate-700').find('i').addClass('fa-volume-mute').removeClass('fa-volume-up');
                $('#soundLabel').text('Loa: Tắt');
            }
        }

        function resetGame() {
            if (confirm("Xóa lịch sử và bắt đầu phiên chơi mới?")) {
                state.calledNumbers = [];
                state.currentNumber = null;
                state.isAutoPlaying = false;
                clearTimeout(autoTimeout);
                $('#mainNumber').text('--');
                persistState();
                renderGrid();
                renderRecentSlots();
                updateAutoBadge();
            }
        }

        function toggleModal(selector) {
            const $modal = $(selector);
            if ($modal.is(':visible')) {
                $modal.fadeOut(200, function() {
                    $(this).addClass('hidden');
                });
            } else {
                $modal.removeClass('hidden').hide().fadeIn(200);
            }
        }

        // --- Ready ---
        $(document).ready(() => {
            init();

            // Gắn sự kiện cho nút tăng/giảm delay
            $('#btnIncreaseDelay').on('click', function(e) {
                e.stopPropagation();
                adjustSpeed(100);
            });

            $('#btnDecreaseDelay').on('click', function(e) {
                e.stopPropagation();
                adjustSpeed(-100);
            });

            $('#menuMainBtn').on('click', function() {
                const $options = $('#menuOptions');
                if ($options.is(':hidden')) {
                    $options.slideDown(300).removeClass('hidden').addClass('flex');
                } else {
                    $options.slideUp(300, function() { $(this).addClass('hidden').removeClass('flex'); });
                }
                $(this).toggleClass('bg-slate-800 rotate-90 border-slate-700 shadow-none');
                $(this).find('i').toggleClass('fa-bars fa-times');
            });

            $('#mainButton').on('click', () => {
                if (state.isAutoModeEnabled) startStopAuto();
                else callNumber();
            });

            $('#autoToggleBtn').on('click', toggleAutoMode);
            $('#soundToggleBtn').on('click', toggleSound);

            $('.modal-overlay').on('click', function(e) {
                if (e.target === this) toggleModal('#' + $(this).attr('id'));
            });

            $(document).on('keydown', (e) => {
                if (e.key === "Escape") {
                    $('.modal-overlay:visible').each(function() {
                        toggleModal('#' + $(this).attr('id'));
                    });
                }
            });
        });
    </script>
</body>
</html>
